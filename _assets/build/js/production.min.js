function $2(a){return document.querySelector(a)}function _template(a,b){var c=$2("#template-"+a).innerHTML;return b?c.replace(/<% ([a-z]+) %>/g,function(a,c){return b[c]}):c}!function(){var a=!1,b=/xyz/.test(function(){})?/\b_super\b/:/.*/;this.Class=function(){},Class.extend=function(c){function d(){!a&&this.init&&this.init.apply(this,arguments)}var e=this.prototype;a=!0;var f=new this;a=!1;for(var g in c)f[g]="function"==typeof c[g]&&"function"==typeof e[g]&&b.test(c[g])?function(a,b){return function(){var c=this._super;this._super=e[a];var d=b.apply(this,arguments);return this._super=c,d}}(g,c[g]):c[g];return d.prototype=f,d.prototype.constructor=d,d.extend=arguments.callee,d}}(),HTMLInputElement.prototype.style=function(a,b){return arguments[1]?(this.style[a]=b,this):window.getComputedStyle(this)[a]},HTMLInputElement.prototype.addClass=function(a){var b=[];this.getAttribute("class")?(b=this.getAttribute("class").replace(/[\s]{2}/," ").split(" "),b.push(a)):b=[a],this.setAttribute("class",b.join(" "))},HTMLInputElement.prototype.removeClass=function(a){var b,c=[];this.getAttribute("class")&&(c=this.getAttribute("class").replace(/[\s]{2}/," ").split(" "),b=c.indexOf(a),-1!=b&&(c.splice(b),this.setAttribute("class",c.join(" "))))},HTMLTextAreaElement.prototype.addClass=HTMLInputElement.prototype.addClass,HTMLTextAreaElement.prototype.removeClass=HTMLInputElement.prototype.removeClass;var Input=new Object;Input.get=function(a){var a=$2('[name="'+a+'"]:checked')||$2('[name="'+a+'"]');return a?a.value:""};var Model=Class.extend({name:"tp-model",id:null,store:null,records:[],init:function(){this.store=localStorage.getItem(this.name),this.records=this.store&&this.store.split(",")||[]},S4:function(){return(65536*(1+Math.random())|0).toString(16).substring(1)},guid:function(){return this.S4()+this.S4()+"-"+this.S4()+"-"+this.S4()+"-"+this.S4()+"-"+this.S4()+this.S4()+this.S4()},create:function(a){return this.fromJSON(a),this.save(),this.id},save:function(){var a=this.toJSON();return this.id?a.id=this.id:(a.id=this.guid(),this.id=a.id,this.records.push(a.id),localStorage.setItem(this.name,this.records.join(","))),localStorage.setItem(this.name+"-"+a.id,JSON.stringify(a)),this.id},find:function(a){var b=JSON.parse(localStorage.getItem(this.name+"-"+a));return this.fromJSON(b),this},findAll:function(){return this.records.map(function(a){var b=JSON.parse(localStorage.getItem(this.name+"-"+a));return this.fromJSON(b),this},this)},fromJSON:function(a){for(var b in a)this[b]=a[b];return this}}),Plan=Model.extend({name:"tp-plan",id:null,title:"",steps:[],startTime:{days:0,hours:0,minutes:0},endTime:{hours:0,minutes:0},duration:{days:0,hours:0,minutes:0},init:function(){this._super()},addStep:function(a){this.steps.constructor!=Array&&(this.steps=this.getSteps()),this.steps.push(a),this.updateDuration(),this.updateStartTime(),this.save()},removeStep:function(a){this.steps.splice(a,1)},getSteps:function(){if(this.steps.constructor!=Array){for(var a=this.steps.split(","),b=[],c=0;c<a.length;c++)if(""!=a[c]){var d=(new Step).find(a[c]);b.push(d)}this.steps=b}return this.steps},toJSON:function(){for(var a=[],b=0;b<this.steps.length;b++)a.push(this.steps[b].id);return{title:this.title,startTime:this.startTime,endTime:this.endTime,steps:a.join(",")}},updateDuration:function(){var a,b,c,d=this.getDurationInMinutes();b=Math.floor(d/60),c=d-60*b,a=Math.floor(b/24),a>0&&(b-=24*a),this.duration={days:a,hours:b,minutes:c}},updateStartTime:function(){var a=0,b=0,c=0,d=60*this.endTime.hours+this.endTime.minutes-this.getDurationInMinutes();0>d?(d=0-d,a=Math.floor(d/60/24),b=Math.floor(60*(1-(d/60/24-a))*24/60),c=Math.round(60*(1-(d/60/24-a))*24-60*b)):(b=Math.floor(d/60),c=d-60*Math.floor(d/60)),this.startTime={days:a,hours:b,minutes:c};for(var e=this.startTime.hours,f=this.startTime.minutes,g=0;g<this.steps.length;g++)if(this.steps[g].setStartTime(e,f),"then"==this.steps[g].type){var h=this.steps[g].getEndTime();e=h.hours,f=h.minutes}},setEndTime:function(a,b){a=a||0,b=b||0,a!==Math.round(a)&&(b+=60*(a-Math.floor(a)),a=Math.floor(a)),b>60&&(a+=Math.floor(b/60),b-=60*Math.floor(b/60)),this.endTime={hours:a,minutes:b},this.updateStartTime()},getDurationInMinutes:function(){var a,b,c=0,d=0,e=0,f=this.steps.length;for(b=0;f>b;b+=1)a=this.steps[b],d=a.getDurationInMinutes(),"meanwhile"!==a.type?(c+=d,e=d):d>e&&(c+=d-e,e=d);return c},getDurationInHours:function(){return this.getDurationInMinutes()/60},getDurationInDays:function(){return this.getDurationInHours()/24},getDurationInText:function(){var a="";return this.duration.days>0&&(a+=this.duration.days,a+=" day",this.duration.days>1&&(a+="s")),this.duration.hours>0&&(""!==a&&(a+=", "),a+=this.duration.hours,a+=" hour",this.duration.hours>1&&(a+="s")),this.duration.minutes>0&&(""!==a&&(a+=", "),a+=this.duration.minutes,a+=" minute",this.duration.minutes>1&&(a+="s")),a}}),Step=Model.extend({name:"tp-step",order:0,type:"",position:0,text:"",duration:{days:0,hours:0,minutes:0},init:function(){this._super()},create:function(a){this.text=a.text,this.type=a.type;var b=parseInt(a.duration),c="hours"==a.unit?b:0,d="minutes"==a.unit?b:0;return this.setDuration(0,c,d),this.save(),this.id},toJSON:function(){return{order:this.order,type:this.type,position:this.position,text:this.text,duration:this.duration}},setDuration:function(a,b,c){a=a||0,b=b||0,c=c||0,b!==Math.round(b)&&(c+=60*(b-Math.floor(b)),b=Math.floor(b)),c>60&&(b+=Math.floor(c/60),c-=60*Math.floor(c/60)),b>24&&(a+=Math.floor(b/24),b-=24*a),this.duration={days:a,hours:b,minutes:c}},setStartTime:function(a,b){a=a||0,b=b||0,a!==Math.round(a)&&(b+=60*(a-Math.floor(a)),a=Math.floor(a)),b>60&&(a+=Math.floor(b/60),b-=60*Math.floor(b/60)),this.startTime={hours:a,minutes:b}},getEndTime:function(){var a=60*this.startTime.hours+this.startTime.minutes+24*this.duration.days*60+60*this.duration.hours+this.duration.minutes,b=Math.floor(a/60),c=a-60*b;return b>24&&(b-=24),{hours:b,minutes:c}},getDurationInMinutes:function(){return 24*this.duration.days*60+60*this.duration.hours+this.duration.minutes},getDurationInHours:function(){return this.getDurationInMinutes()/60},getDurationInDays:function(){return this.getDurationInHours()/24},getDurationInText:function(){var a="";return this.duration.days>0&&(a+=this.duration.days,a+=" day",this.duration.days>1&&(a+="s")),this.duration.hours>0&&(""!==a&&(a+=", "),a+=this.duration.hours,a+=" hour",this.duration.hours>1&&(a+="s")),this.duration.minutes>0&&(""!==a&&(a+=", "),a+=this.duration.minutes,a+=" minute",this.duration.minutes>1&&(a+="s")),a}}),BaseController=Class.extend({el:$2(".tiny-planner"),events:[],loadEvents:function(a){for(var b=0;b<this.events.length;b++)this.el.removeEventListener("keypress",this.events[b],!1);this.el.addEventListener("keypress",a,!1),this.events.push(a)},loadClickEvents:function(a){for(var b=0;b<this.events.length;b++)this.el.removeEventListener("click",this.events[b],!1);this.el.addEventListener("click",a,!1),this.events.push(a)}}),PlanController=BaseController.extend({current_plan:null,steps:[],init:function(){},index:function(){var a=this,b=(new Plan).findAll(),c="";if(b.length){c="";for(var d=0;d<b.length;d++)c+='<li class="step"><a href="#plan/edit/'+b[d].id+'">'+b[d].title+"</a></li>"}else c="<li><p>You haven't created any plans yet, but that's OK!</p></li>";this.el.innerHTML=_template("plans-index",{plans:c});var e=function(b){13==b.keyCode&&a.create()};this.loadEvents(e);var f=function(b){"field"==b.target.className&&a.create()};this.loadClickEvents(f)},create:function(){var a=Input.get("plan-title"),b=parseInt(Input.get("plan-hour")),c=parseInt(Input.get("plan-minute")),d=Input.get("meridian"),e=!1;if(""==a&&($2('[name="plan-title"]').addClass("error"),e=!0),0/0==c&&($2('[name="plan-hour"]').addClass("error"),e=!0),0/0==c&&($2('[name="plan-minute"]').addClass("error"),e=!0),!e){"pm"==d&&(b+=12);var f=new Plan;f.title=a,f.setEndTime(b,c),f.save(),this.current_plan=f,tinyrouter.go("plan/edit/"+f.id)}},edit:function(a){var b=(new Plan).find(a),c=b.getSteps();b.updateDuration(),b.updateStartTime(),this.current_plan=b,this.el.innerHTML=_template("plans-edit",{title:b.title,starttime:b.startTime.hours+":"+(parseInt(b.startTime.minutes)<10?"0"+b.startTime.minutes:b.startTime.minutes),endtime:b.endTime.hours+":"+(parseInt(b.endTime.minutes)<10?"0"+b.endTime.minutes:b.endTime.minutes),totalduration:b.getDurationInText()}),this.el.querySelector(".new-step-form").innerHTML=_template("add-first-step");for(var d="",e=0;e<c.length;e++){var f=c[e];d+=_template("step",{type:f.type,text:f.text,duration:f.getDurationInText(),starttime:"then"==f.type?f.startTime.hours+":"+(f.startTime.minutes<10?"0"+f.startTime.minutes:f.startTime.minutes):""})}this.el.querySelector(".plan-steps").innerHTML=d,this.el.querySelector(".new-step-form").innerHTML=_template("add-step");var g=function(a){13==a.keyCode&&tinyrouter.route("step/create/"+b.id)};this.loadEvents(g);var h=function(a){"button"==a.target.nodeName.toLowerCase()&&tinyrouter.route("step/create/"+b.id)};this.loadClickEvents(h)}}),StepController=BaseController.extend({create:function(a){var b=(new Plan).find(a),c=$2('[name="step-type"]:checked')?$2('[name="step-type"]:checked').value:"",d={order:0,type:""==c?"first":c,position:0,text:Input.get("step-title"),duration:parseInt(Input.get("step-duration")),unit:Input.get("step-unit")},e=new Step,f=!1;if($2('[name="step-title"]').removeClass("error"),$2('[name="step-duration"]').removeClass("error"),""==Input.get("step-title")&&($2('[name="step-title"]').addClass("error"),f=!0),""==Input.get("step-duration")&&($2('[name="step-duration"]').addClass("error"),f=!0),!f){var a=e.create(d);b.addStep(e);for(var g=b.getSteps(),h="",i=0;i<g.length;i++){var j=g[i];h+=_template("step",{type:j.type,text:j.text,duration:j.getDurationInText(),starttime:"then"==j.type?j.startTime.hours+":"+(j.startTime.minutes<10?"0"+j.startTime.minutes:j.startTime.minutes):""})}this.el.querySelector(".plan-steps").innerHTML=h,this.el.querySelector(".new-step-form").innerHTML=_template("add-step"),tinyrouter.route("plan/edit/"+b.id)}}}),TinyRouter=Class.extend({routes:{"":"Plan",plan:"Plan","plan/new":"Plan@new","plan/edit":"Plan@edit","step/create":"Step@create"},init:function(){var a=this;this.route(),window.addEventListener("hashchange",function(){a.route()},!1)},route:function(a){a||(a=window.location.hash.replace("#",""));var b=0;if(3==a.split("/").length){var c=a.split("/");b=c[2],a=c[0]+"/"+c[1]}var d=this.routes[a];if(void 0!==d){var e=d.match(/(\w+)@?(\w+)?/);if(e.length){var f=e[1]+"Controller",g=new window[f];e[2]?g[e[2]]&&g[e[2]](b):g.index&&g.index()}}},go:function(a){window.location="#"+a}});document.onreadystatechange=function(){"complete"==document.readyState&&(window.tinyrouter=new TinyRouter)};